name: Salesforce Code Analyzer
on:
  pull_request:
    types: [opened, edited, synchronized]
  workflow_dispatch:

jobs:
  code_analyzer:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Salesforce CLI
        run: npm install -g @salesforce/cli@latest
      - name: Install Code Analyzer plugin
        run: sf plugins install @salesforce/plugin-code-analyzer@latest
      - name: Run Code Analyzer
        uses: forcedotcom/run-code-analyzer@v1
        with:
          run-command: run
          run-arguments: "--normalize-severity --target . --outfile results.html"
          results-artifact-name: analyzer-results
      - name: Fail build on violations
        if: steps.run-code-analyzer.outputs.exit-code > 0 ||
             steps.run-code-analyzer.outputs.num-sev1-violations > 0 ||
             steps.run-code-analyzer.outputs.num-violations > 10
        run: exit 1
    
      - name: Run Salesforce Code Analyzer Scan
        run: |
          sf code-analyzer run --output-file sfca_results.sarif

      - name: Upload SARIF file to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: sfca_results.sarif
